name: Detect Stop Pattern Changes

on:
  # schedule:
  #   # 毎日 09:00 JST (00:00 UTC) に実行
  #   - cron: '0 0 * * *'
  workflow_dispatch:
    # 手動実行も可能
    inputs:
      operators:
        description: 'Operators to check (comma-separated, or "all")'
        required: false
        default: 'TokyoMetro,Toei'

jobs:
  detect-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}

      - name: Run ECS Task
        id: run-task
        run: |
          # ECSタスクを実行
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --task-definition ${{ vars.ECS_TASK_DEFINITION }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ vars.ECS_SUBNETS }}],securityGroups=[${{ vars.ECS_SECURITY_GROUPS }}],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "detect-stop-patterns",
                "command": ["./detect_stop_patterns", "-o", "${{ github.event.inputs.operators || 'TokyoMetro,Toei' }}"]
              }]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "task_arn=$TASK_ARN" >> $GITHUB_OUTPUT
          echo "Started ECS task: $TASK_ARN"

      - name: Wait for ECS Task
        id: wait-task
        run: |
          echo "Waiting for task to complete..."
          aws ecs wait tasks-stopped \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --tasks ${{ steps.run-task.outputs.task_arn }}

          # タスクの終了コードを確認
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --tasks ${{ steps.run-task.outputs.task_arn }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          echo "Task completed with exit code: $EXIT_CODE"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Get task logs
        id: logs
        run: |
          # CloudWatch Logsからログを取得
          TASK_ID=$(echo "${{ steps.run-task.outputs.task_arn }}" | rev | cut -d'/' -f1 | rev)

          # ログストリーム名を構築（タスク定義の設定に依存）
          LOG_STREAM="detect-stop-patterns/$TASK_ID"

          # リトライループでログを取得（CloudWatch Logsへの配信遅延対策）
          MAX_RETRIES=5
          RETRY_DELAY=10
          OUTPUT=""

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempting to fetch logs (attempt $i/$MAX_RETRIES)..."

            if RESULT=$(aws logs get-log-events \
              --log-group-name ${{ vars.ECS_LOG_GROUP }} \
              --log-stream-name "$LOG_STREAM" \
              --query 'events[*].message' \
              --output text 2>&1); then
              if [ -n "$RESULT" ] && [ "$RESULT" != "None" ]; then
                OUTPUT="$RESULT"
                echo "Successfully fetched logs"
                break
              fi
            else
              echo "AWS CLI error: $RESULT"
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done

          if [ -z "$OUTPUT" ]; then
            echo "Warning: Could not fetch logs after $MAX_RETRIES attempts"
            OUTPUT="(ログの取得に失敗しました)"
          fi

          # シークレットパターンをマスク
          SANITIZED=$(echo "$OUTPUT" | \
            sed -E 's/ODPT_API_KEY=[^ ]*/ODPT_API_KEY=***REDACTED***/g' | \
            sed -E 's/DATABASE_URL=[^ ]*/DATABASE_URL=***REDACTED***/g' | \
            sed -E 's/postgres:\/\/[^@]*@/postgres:\/\/***:***@/g' | \
            sed -E 's/GITHUB_TOKEN=[^ ]*/GITHUB_TOKEN=***REDACTED***/g' | \
            sed -E 's/Bearer [A-Za-z0-9_-]+/Bearer ***REDACTED***/g' | \
            sed -E 's/[a-zA-Z0-9]{20,}/***POSSIBLE_SECRET***/g')

          echo "$SANITIZED"

          # 結果を保存
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$SANITIZED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 変更があったかチェック
          if echo "$SANITIZED" | grep -q "検出された変更"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if changes detected
        if: steps.logs.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          LOG_RESULT: ${{ steps.logs.outputs.result }}
        with:
          script: |
            const result = process.env.LOG_RESULT || '';
            const today = new Date().toISOString().split('T')[0];

            const body = [
              '## 停車パターン変更が検出されました',
              '',
              '```',
              result,
              '```',
              '',
              '---',
              'このIssueは GitHub Actions により自動作成されました。',
              '変更を確認したら、DBで `acknowledged = TRUE` に更新してください。'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[自動検出] 停車パターン変更 ${today}`,
              body: body,
              labels: ['stop-pattern-change', 'automated']
            });
